<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Reinah Fit V8.9 Premium (Fixed)</title>

  <link rel="icon" type="image/jpeg" href="logo.jpg" />
  <link rel="apple-touch-icon" href="logo.jpg" />

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#050505" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ --bg:#050505; --card:#121212; --orange:#ff6600; --blue:#007bff; --green:#00e676; --red:#ff3333; --red-pro:#d90429; --text:#fff; --muted:#888; --radius: 20px; }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent;}
    body{ background:var(--bg); color:var(--text); display:flex; justify-content:center; min-height:100vh; overflow-x:hidden; }
    #mobile-frame{ width:100%; max-width:480px; background:#0a0a0a; min-height:100vh; padding-bottom:100px; position:relative; box-shadow:0 0 50px rgba(217,4,41,.05); z-index:1; }
    ::-webkit-scrollbar{width:5px;} ::-webkit-scrollbar-track{background:#0a0a0a;} ::-webkit-scrollbar-thumb{background:#333;border-radius:10px;}
    .hidden{display:none !important;}
    .screen{display:none;padding:20px;animation:fade .3s;}
    .screen.active{display:block;}
    @keyframes fade{from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);}}
    #screen-lock.active{ display:flex;flex-direction:column;justify-content:center;align-items:center; height:100vh;text-align:center;z-index:20000;background:var(--bg); position:absolute;top:0;width:100%;left:0; }

    /* MODAIS */
    .modal-overlay{ position:fixed;top:0;left:0;width:100%;height:100%; background:rgba(0,0,0,.95); z-index:3000; display:flex;justify-content:center;align-items:center; backdrop-filter: blur(7px); }
    #custom-modal,#prompt-modal{z-index:99999 !important;background:rgba(0,0,0,.98);}
    .modal-box{ background:linear-gradient(180deg, rgba(30,30,30,.9), rgba(10,10,10,.92)); width:95%; max-width:450px; padding:18px; border-radius:24px; border:1px solid rgba(255,255,255,.08); text-align:center; box-shadow:0 20px 60px rgba(0,0,0,.65); max-height:90vh; overflow-y:auto; position:relative; }
    .modal-title{font-size:1.05rem;color:var(--orange);font-weight:900;margin-bottom:12px;letter-spacing:.3px;}
    .modal-msg{color:#ccc;font-size:.9rem;margin-bottom:18px;line-height:1.5;white-space:pre-wrap;}

    /* CARDS */
    .card{ background: radial-gradient(120% 140% at 0% 0%, rgba(255,255,255,.06), rgba(0,0,0,0)) , linear-gradient(180deg, rgba(20,20,20,.92), rgba(10,10,10,.92)); padding:16px; border-radius:var(--radius); border:1px solid rgba(255,255,255,.06); margin-bottom:12px; position:relative; box-shadow: 0 12px 40px rgba(0,0,0,.35); }
    button{ width:100%; padding:14px; border-radius:14px; border:none; font-weight:800; cursor:pointer; font-size:.92rem; transition:.18s; display:flex;justify-content:center;align-items:center;gap:8px; }
    button:active{transform:scale(.985);}
    .btn-orange{background:var(--orange);color:#fff;box-shadow:0 8px 24px rgba(255,102,0,.22);}
    .btn-blue{background:var(--blue);color:#fff;box-shadow:0 8px 24px rgba(0,123,255,.18);}
    .btn-red{background:var(--red-pro);color:#fff;box-shadow:0 8px 24px rgba(217,4,41,.18);}
    .btn-outline{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.12);color:#ccc;}
    .btn-outline:hover{border-color:rgba(255,102,0,.55);color:var(--orange);}
    .btn-icon{width:44px;height:44px;font-size:1rem;border-radius:50%;padding:0;display:flex;align-items:center;justify-content:center;}
    .btn-sm{width:auto;padding:8px 12px;font-size:.82rem;border-radius:12px;}
    input,select,textarea{ width:100%; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:12px; margin-bottom:10px; outline:none; font-size:1rem; }
    input:focus{border-color:rgba(255,102,0,.85);}

    /* HEADER & NAV */
    .header-tech{display:flex;justify-content:space-between;align-items:center;padding:20px 20px 0 20px;}
    .header-avatar-small{ width:40px;height:40px;border-radius:50%; background-size:cover;background-position:center; border:2px solid var(--orange); background-color:#333; box-shadow:0 8px 20px rgba(0,0,0,.55); }
    .mentor-box{border-left:4px solid var(--orange);background:linear-gradient(90deg, rgba(26,26,26,.9), rgba(9,9,9,.9));}
    .date-nav{ display:flex; align-items:center; justify-content:center; gap:18px; padding:14px 14px; border-radius:24px; border:1px solid rgba(255,255,255,.08); background: linear-gradient(180deg, rgba(22,22,22,.78), rgba(10,10,10,.78)); box-shadow: 0 10px 30px rgba(0,0,0,.45); margin-bottom:14px; }
    .date-nav .nav-btn{ width:54px;height:54px;border-radius:18px; background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08); display:flex;align-items:center;justify-content:center; cursor:pointer; transition:.15s; }
    .date-nav i{color:var(--orange);font-size:1.35rem;}
    .date-nav .nav-label{ font-size:.95rem; color:#aaa; letter-spacing:.2px; font-weight:800; }
    .date-nav .nav-label strong{color:var(--orange);font-weight:900;}

    /* Split √Ågua + Sono */
    .split-trackers{ display:flex; gap:12px; padding:14px; }
    .tracker-box{ flex:1; min-width:0; display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:18px; background: rgba(0,0,0,.24); box-shadow: inset 0 0 0 1px rgba(255,255,255,.02); }
    .tracker-left{ display:flex; align-items:center; gap:8px; min-width:0; flex:1; }
    .tracker-value{ font-weight:900; font-size:.95rem; white-space:nowrap; }
    .tracker-actions{ display:flex; gap:6px; flex-shrink:0; }
    .tracker-actions button{ width:28px; height:28px; border-radius:50%; font-size:.85rem; display:flex; align-items:center; justify-content:center; }

    /* DASHBOARD GRID (NOVO ESTILO PARA O MODAL) */
    .dash-grid-med { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .d-card { background:#0a0a0a; padding:10px 2px; border-radius:12px; border:1px solid rgba(255,255,255,.1); text-align:center; display:flex; flex-direction:column; justify-content:center; }
    .d-val { font-size:0.85rem; font-weight:900; display:block; color:#fff; }
    .d-lbl { font-size:0.55rem; color:#888; text-transform:uppercase; margin-top:3px; letter-spacing:0.5px; }
    .modal-section-title { font-size:0.8rem; color:var(--blue); margin:15px 0 8px; text-transform:uppercase; border-bottom:1px solid rgba(255,255,255,.1); padding-bottom:5px; text-align:left; font-weight:800; }

    /* MACROS, DOCK, TOAST */
    .macro-table{width:100%;border-collapse:collapse;font-size:.9rem;text-align:center;}
    .macro-table th{color:#666;font-weight:400;font-size:.75rem;padding-bottom:8px;border-bottom:1px solid #222;}
    .macro-table td{padding:10px 0;border-bottom:1px solid #1a1a1a;}
    .macro-val{font-weight:800;color:#fff;}
    .dock{ position:fixed;bottom:20px;left:50%; transform:translateX(-50%); width:92%;max-width:440px; background:rgba(20,20,20,.92); backdrop-filter:blur(12px); padding:10px; border-radius:26px; display:flex;justify-content:space-around; border:1px solid rgba(255,255,255,.1); z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .dock-item{color:#555;font-size:1.4rem;display:flex;flex-direction:column;align-items:center;cursor:pointer;transition:.3s;padding:5px;}
    .dock-item.active{color:var(--orange);transform:translateY(-4px);}
    .dock-item span{font-size:.65rem;margin-top:3px;font-weight:700;}
    #toast-box{position:fixed;top:20px;left:50%;transform:translateX(-50%);width:90%;z-index:4000;pointer-events:none;display:flex;flex-direction:column;gap:10px;}
    .toast{background:#222;color:#fff;padding:12px 20px;border-radius:50px;border:1px solid #444;text-align:center;font-size:.9rem;animation:slideD .3s;}
    @keyframes slideD{from{transform:translateY(-10px);opacity:0}to{transform:translateY(0);opacity:1}}

    /* REPORT STYLES */
    .rep-section-title{ font-weight:900; font-size:1.05rem; margin:6px 0 12px 0; color:#fff; letter-spacing:.2px; }
    .rep-grid-compact{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:8px;}
    .rep-mini-card{ background:rgba(0,0,0,.22); padding:10px 6px; border-radius:14px; border:1px solid rgba(255,255,255,.08); text-align:center; }
    .rep-mini-val{font-size:.92rem;font-weight:900;color:#fff;}
    .rep-mini-label{font-size:.56rem;color:#888;text-transform:uppercase;margin-top:3px;}
    .rep-day-card{ background: linear-gradient(180deg, rgba(18,18,18,.92), rgba(10,10,10,.92)); border:1px solid rgba(255,255,255,.08); border-radius:20px; padding:14px; margin-bottom:10px; }
    .rep-day-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .rep-pill{ padding:8px 10px; border-radius:999px; background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.08); font-weight:800; font-size:.82rem; }
    .rep-subline{ display:flex; justify-content:space-between; gap:12px; font-size:.92rem; margin-top:6px; }
    .rep-insight{ margin-top:10px; padding:10px 12px; border-radius:16px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); color:#ddd; font-size:.84rem; }

    /* PRINT FIX */
    @media print {
        body > * { display: none !important; }
        #laudo-modal, #laudo-modal * { display: block !important; visibility: visible !important; }
        #laudo-modal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white !important; color: black !important; border: none; }
        .modal-overlay { background: white !important; position: static; }
        .modal-box { box-shadow: none; border: none; max-width: 100%; width: 100%; }
        .d-card { border: 1px solid #ccc !important; background: #fff !important; color: black !important; }
        .d-val { color: black !important; }
        .d-lbl { color: #555 !important; }
        .modal-section-title { color: #000 !important; border-bottom: 1px solid #000 !important; }
        button { display: none !important; }
    }
  </style>
</head>

<body>
  <div id="mobile-frame">
    <div id="toast-box"></div>
    <input type="file" id="prof-pic-input" accept="image/*" class="hidden">

    <div id="screen-lock" class="screen active">
      <h1 style="font-size:2.5rem; margin-top:20vh;">REINAH<span style="color:var(--red-pro)">.FIT</span></h1>
      <p style="color:#666; margin-bottom:40px; font-size:0.8rem; letter-spacing:2px;">OS V8.9 PREMIUM</p>
      <div style="width:260px;">
        <input type="password" id="login-pin" placeholder="PIN" style="text-align:center; font-size:1.5rem; letter-spacing:8px;" maxlength="4" inputmode="numeric">
        <button class="btn-red" onclick="doLogin()">ACESSAR</button>
        <p style="margin-top:50px; font-size:0.75rem; color:#444; cursor:pointer;" onclick="emergencyReset()">[ RESETAR SISTEMA ]</p>
      </div>
    </div>

    <div id="tab-home" class="screen">
      <div class="header-tech">
        <div style="display:flex; align-items:center; gap:12px;">
          <div id="header-avatar" class="header-avatar-small" onclick="nav('profile')"></div>
          <h2 id="home-greeting">Ol√°, King</h2>
        </div>
        <div style="display:flex; gap:15px;">
          <i class="fas fa-calendar-alt" style="color:var(--orange); font-size:1.2rem; cursor:pointer;" onclick="openReport()"></i>
        </div>
      </div>

      <div class="date-nav" style="margin: 12px 0 16px 0;">
        <div class="nav-btn" onclick="changeGlobalDate(-1)"><i class="fas fa-chevron-left"></i></div>
        <div class="nav-label">Em: <strong id="global-date-display">Hoje</strong></div>
        <div class="nav-btn" onclick="changeGlobalDate(1)"><i class="fas fa-chevron-right"></i></div>
      </div>

      <div class="card mentor-box">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
          <i class="fas fa-robot" style="color:var(--orange);"></i> <strong>MENTOR IQ</strong>
        </div>
        <p id="mentor-msg" style="font-size:0.95rem; line-height:1.4; color:#ddd;">Analisando...</p>
      </div>

      <div class="card split-trackers">
        <div class="tracker-box">
          <div class="tracker-left">
            <i class="fas fa-tint" style="color:var(--blue)"></i>
            <span id="water-display-compact" class="tracker-value">0 / 3000ml</span>
          </div>
          <div class="tracker-actions">
            <button class="btn-icon btn-outline tracker-btn" style="border-color:#333; color:#666;" onclick="addWater(-250)"><i class="fas fa-minus"></i></button>
            <button class="btn-icon btn-blue tracker-btn" onclick="addWater(250)"><i class="fas fa-plus"></i></button>
          </div>
        </div>
        <div class="tracker-box">
          <div class="tracker-left">
            <i class="fas fa-moon" style="color:var(--orange)"></i>
            <span id="sleep-display-compact" class="tracker-value">0.0 / 8.0h</span>
          </div>
          <div class="tracker-actions">
            <button class="btn-icon btn-outline tracker-btn" style="border-color:#333; color:#666;" onclick="addSleep(-0.5)"><i class="fas fa-minus"></i></button>
            <button class="btn-icon btn-orange tracker-btn" onclick="addSleep(0.5)"><i class="fas fa-plus"></i></button>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="height:150px;"><canvas id="chart-main"></canvas></div>
        <div style="display:flex; justify-content:center; gap:20px; font-size:0.8rem; margin-top:8px; color:#666;">
          <span style="color:var(--blue)">üîµ Comida</span>
          <span style="color:var(--orange)">üü† Queima</span>
        </div>
      </div>

      <div class="card">
        <h4 style="color:var(--orange); margin-bottom:10px; font-size:0.95rem; font-weight:900;">MACROS</h4>
        <table class="macro-table">
          <thead><tr><th style="text-align:left;">Item</th><th>Meta</th><th>Feito</th><th>Saldo</th></tr></thead>
          <tbody id="macro-table-body"></tbody>
        </table>
      </div>
    </div>

    <div id="tab-diet" class="screen">
      <div style="display:flex; justify-content:space-between; align-items:center; margin:10px 0 15px 0;">
        <h2>Dieta</h2>
        <button class="btn-outline btn-sm" style="width:auto;" onclick="openManageFoods()"><i class="fas fa-apple-alt"></i> Alimentos</button>
      </div>
      <div class="date-nav" style="margin: 0 0 16px 0;">
        <div class="nav-btn" onclick="changeGlobalDate(-1)"><i class="fas fa-chevron-left"></i></div>
        <div class="nav-label">Em: <strong id="diet-date-display">Hoje</strong></div>
        <div class="nav-btn" onclick="changeGlobalDate(1)"><i class="fas fa-chevron-right"></i></div>
      </div>
      <div class="card">
        <div class="meal-selector" style="display:flex; gap:8px; flex-wrap:wrap; padding-bottom:5px; margin-bottom:10px;">
          <button class="meal-btn selected" onclick="selMeal(this, 'Caf√© da Manh√£')" style="flex:1 0 auto; white-space:nowrap; padding:10px 16px; background:#222; border-radius:14px; font-size:0.82rem; color:#888; border:1px solid #333; text-align:center;">‚òï Caf√©</button>
          <button class="meal-btn" onclick="selMeal(this, 'Almo√ßo')" style="flex:1 0 auto; white-space:nowrap; padding:10px 16px; background:#222; border-radius:14px; font-size:0.82rem; color:#888; border:1px solid #333; text-align:center;">ü•ó Almo√ßo</button>
          <button class="meal-btn" onclick="selMeal(this, 'Caf√© da Tarde')" style="flex:1 0 auto; white-space:nowrap; padding:10px 16px; background:#222; border-radius:14px; font-size:0.82rem; color:#888; border:1px solid #333; text-align:center;">üçé Tarde</button>
          <button class="meal-btn" onclick="selMeal(this, 'Jantar')" style="flex:1 0 auto; white-space:nowrap; padding:10px 16px; background:#222; border-radius:14px; font-size:0.82rem; color:#888; border:1px solid #333; text-align:center;">üç≤ Jantar</button>
          <button class="meal-btn" onclick="selMeal(this, 'Ceia')" style="flex:1 0 auto; white-space:nowrap; padding:10px 16px; background:#222; border-radius:14px; font-size:0.82rem; color:#888; border:1px solid #333; text-align:center;">üåô Ceia</button>
          <button class="meal-btn" onclick="selMeal(this, 'Extra')" style="flex:1 0 auto; white-space:nowrap; padding:10px 16px; background:#222; border-radius:14px; font-size:0.82rem; color:#888; border:1px solid #333; text-align:center;">‚ûï Extra</button>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <div style="flex:2;"><input type="text" id="diet-food-name" placeholder="O que?" list="food-datalist"><datalist id="food-datalist"></datalist></div>
          <div style="flex:1;"><input type="number" id="diet-food-qty" placeholder="Qtd" value="1"></div>
        </div>
        <button class="btn-orange" onclick="addDiet()">Registrar</button>
      </div>
      <div id="diet-log-container" style="padding-bottom:30px;"></div>
    </div>

    <div id="tab-workout" class="screen">
      <div style="display:flex; justify-content:space-between; align-items:center; margin:10px 0 15px 0;">
        <h2>Treino</h2>
        <button class="btn-outline btn-sm" onclick="createNewGroup()"><i class="fas fa-plus"></i> Ficha</button>
      </div>
      <div class="date-nav" style="margin: 0 0 16px 0;">
        <div class="nav-btn" onclick="changeGlobalDate(-1)"><i class="fas fa-chevron-left"></i></div>
        <div class="nav-label">Em: <strong id="workout-date-display">Hoje</strong></div>
        <div class="nav-btn" onclick="changeGlobalDate(1)"><i class="fas fa-chevron-right"></i></div>
      </div>
      <div class="card">
        <strong style="color:var(--green); font-size:0.95rem;">‚ö° CONDICIONAMENTO</strong>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin:10px 0;">
          <button class="btn-outline" style="padding:10px; font-size:1.5rem; border-color:#333;" onclick="setCardio('Corrida')">üèÉ</button>
          <button class="btn-outline" style="padding:10px; font-size:1.5rem; border-color:#333;" onclick="setCardio('Luta')">ü•ä</button>
          <button class="btn-outline" style="padding:10px; font-size:1.5rem; border-color:#333;" onclick="setCardio('Bike')">üö¥</button>
          <button class="btn-outline" style="padding:10px; font-size:1.25rem; border-color:rgba(255,102,0,.6); color:var(--orange);" onclick="openTabata()"><i class="fas fa-stopwatch"></i></button>
        </div>
        <div style="display:flex; gap:10px;">
          <input type="text" id="cardio-desc" placeholder="Outro..." style="flex:2">
          <input type="number" id="cardio-min" placeholder="Min" style="flex:1" oninput="calcCardioPreview()">
        </div>
        <div style="margin-top:10px; background:#0b0b0b; padding:12px; border-radius:14px; display:flex; align-items:center; justify-content:space-between; border:1px solid rgba(255,255,255,.08);">
          <label style="margin:0; color:#888;">Gasto Estimado (Kcal)</label>
          <input type="number" id="cardio-cal-preview" placeholder="0" style="width:110px; text-align:center; color:var(--orange); font-weight:900; margin:0; border:1px solid #444; border-radius:12px;">
        </div>
        <button class="btn-outline btn-sm" style="border-color:rgba(0,230,118,.7); color:var(--green); margin-top:12px;" onclick="addCardio()">Registrar</button>
      </div>
      <div id="workout-render-area"></div>
      <h4 style="margin-top:18px; color:#666; font-size:0.95rem;">Hist√≥rico Selecionado</h4>
      <div id="workout-log-today" style="padding-bottom:30px;"></div>
    </div>

    <div id="tab-profile" class="screen">
      <div style="display:flex; justify-content:space-between; align-items:center; margin:10px 0 15px 0;">
        <h2>Perfil</h2>
        <button class="btn-outline btn-sm" style="width:auto;" onclick="nav('tech')"><i class="fas fa-cog"></i> Config</button>
      </div>
      <div class="card" style="text-align:center;">
        <div id="profile-avatar-box" class="header-avatar-small" style="width:110px;height:110px;border-radius:50%;margin:0 auto 14px auto;display:flex;justify-content:center;align-items:center;font-size:2.5rem;color:#444;border:2px solid var(--orange);background-size:cover;background-position:center;cursor:pointer;position:relative;overflow:hidden;" onclick="triggerPhotoUpload()">
          <i class="fas fa-user" id="avatar-default-icon"></i>
          <div style="position:absolute;bottom:0;width:100%;background:rgba(0,0,0,.6);font-size:.75rem;color:#fff;padding:6px 0;text-align:center;">Editar Foto</div>
        </div>
        <h3 id="prof-name-disp">Nome</h3>
        <p id="prof-goal-disp" style="color:var(--orange); font-size:0.92rem;">Objetivo</p>
      </div>
      <div class="card" style="border:1px solid rgba(217,4,41,.55);">
        <h4 style="color:var(--red-pro); margin-bottom:15px; display:flex; align-items:center; gap:8px;"><i class="fas fa-dna"></i> BIO-TRACKER</h4>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
          <button class="btn-outline" style="border-color:rgba(217,4,41,.55); color:var(--red-pro);" onclick="openPhysicalModal()"><i class="fas fa-ruler-combined"></i> Nova Medida</button>
          <button class="btn-outline" style="border-color:rgba(0,123,255,.55); color:var(--blue);" onclick="openMedicalModal()"><i class="fas fa-tint"></i> Exames</button>
        </div>
        <div id="latest-assessment-card" class="hidden" style="margin:15px 0; background:#0a0a0a; padding:12px; border-radius:16px; font-size:0.85rem; border:1px solid rgba(255,255,255,.08);">
          <div style="color:var(--orange); font-weight:900; margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,.06); padding-bottom:8px;">üìã √öltimo Resultado (<span id="last-assess-date"></span>)</div>
          <div style="display:flex; justify-content:space-between; text-align:center; margin-bottom:12px;">
            <div style="display:flex; flex-direction:column;"><span style="color:#888; font-size:0.7rem;">Peso</span><strong id="last-assess-w" style="font-size:1rem;"></strong></div>
            <div style="display:flex; flex-direction:column;"><span style="color:#888; font-size:0.7rem;">BF%</span><strong id="last-assess-bf" style="font-size:1rem; color:var(--red-pro);"></strong></div>
            <div style="display:flex; flex-direction:column;"><span style="color:#888; font-size:0.7rem;">Massa Magra</span><strong id="last-assess-lean" style="font-size:1rem; color:var(--blue);"></strong></div>
          </div>
          <button class="btn-blue btn-sm" onclick="openLatestReportModal()"><i class="fas fa-file-alt"></i> Dashboard do Laudo</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <button class="btn-outline" onclick="openHistoryModal()"><i class="fas fa-folder-open"></i> Hist√≥rico</button>
          <button class="btn-red" onclick="openEvolutionModal()"><i class="fas fa-chart-line"></i> Evolu√ß√£o</button>
        </div>
      </div>
      <div class="card">
        <h4 style="margin-bottom:15px; color:#888; font-size:0.95rem; border-bottom:1px solid rgba(255,255,255,.06); padding-bottom:10px;">Dados Biom√©tricos</h4>
        <label>Nome do Atleta</label><input type="text" id="prof-name">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div><label>Idade</label><input type="number" id="prof-age"></div>
          <div><label>Altura (cm)</label><input type="number" id="prof-height"></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <div><label>Peso (kg)</label><input type="number" id="prof-weight"></div>
          <div><label>Envergadura (cm)</label><input type="number" id="prof-wingspan"></div>
        </div>
        <label>Sexo</label><select id="prof-sex"><option value="m">Masculino</option><option value="f">Feminino</option></select>
        <label style="margin-top:10px;">Objetivo Atual</label><input type="text" id="prof-goal">
      </div>
      <div class="card">
        <h4 style="margin-bottom:10px; color:var(--orange); font-size:0.95rem; font-weight:900;">‚öôÔ∏è Configura√ß√£o de Metas</h4>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#0b0b0b; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.08);">
          <span style="font-size:0.9rem;">Calcular Auto</span>
          <label class="switch" style="position:relative;display:inline-block;width:50px;height:26px;">
            <input type="checkbox" id="prof-auto-switch" onchange="toggleAutoTargets()" style="opacity:0;width:0;height:0;">
            <span class="slider round" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#333;transition:.4s;border-radius:34px;"></span>
          </label>
        </div>
        <div id="manual-targets-area" style="transition:.25s;">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div><label>Kcal</label><input type="number" id="prof-goal-kcal"></div>
            <div><label>Prot (g)</label><input type="number" id="prof-goal-p"></div>
            <div><label>Carb (g)</label><input type="number" id="prof-goal-c"></div>
            <div><label>Gord (g)</label><input type="number" id="prof-goal-f"></div>
          </div>
        </div>
      </div>
      <button class="btn-blue" onclick="saveProfile()">Salvar Dados</button>
      <div style="height:50px;"></div>
    </div>

    <div id="tab-tech" class="screen">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2>Sistema</h2>
        <button class="btn-outline btn-sm" style="width:auto;" onclick="nav('home')">Voltar</button>
      </div>
      <div class="card">
        <h4 style="color:#888; margin-bottom:10px;">Dados e Backup</h4>
        <button class="btn-outline" onclick="exportDB()">‚¨áÔ∏è Fazer Backup</button>
        <input type="file" id="import-file" class="hidden" onchange="importDB(event)">
        <button class="btn-outline" style="margin-top:10px;" onclick="document.getElementById('import-file').click()">‚¨ÜÔ∏è Restaurar Backup</button>
        <hr style="border:0; border-top:1px solid rgba(255,255,255,.08); margin:20px 0;">
        <button class="btn-danger" onclick="sysConfirm('ATEN√á√ÉO: Resetar o sistema apaga tudo. Confirmar?', resetSystem)">‚ö†Ô∏è RESETAR SISTEMA</button>
      </div>
    </div>

    <div class="dock">
      <div class="dock-item active" onclick="nav('home', this)"><i class="fas fa-home"></i><span>Home</span></div>
      <div class="dock-item" onclick="nav('diet', this)"><i class="fas fa-utensils"></i><span>Dieta</span></div>
      <div class="dock-item" onclick="nav('workout', this)"><i class="fas fa-dumbbell"></i><span>Treino</span></div>
      <div class="dock-item" onclick="nav('profile', this)"><i class="fas fa-user"></i><span>Perfil</span></div>
    </div>
  </div>

  <div id="custom-modal" class="modal-overlay hidden">
    <div class="modal-box">
      <div id="cm-title" class="modal-title">Aviso</div>
      <div id="cm-msg" class="modal-msg">...</div>
      <div style="display:flex; gap:10px; margin-top:15px;">
        <button id="cm-btn-cancel" class="btn-outline" onclick="closeCustomModal()">Cancelar</button>
        <button id="cm-btn-ok" class="btn-orange">OK</button>
      </div>
    </div>
  </div>

  <div id="laudo-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:left; max-width:520px;">
      <div class="modal-title" style="text-align:center;">üìÑ Dashboard do Laudo</div>
      <div id="laudo-content"></div>
      <div style="display:flex; gap:10px; margin-top:20px;">
          <button class="btn-outline" onclick="document.getElementById('laudo-modal').classList.add('hidden')">Fechar</button>
          <button class="btn-blue" onclick="window.print()">Imprimir PDF</button>
      </div>
    </div>
  </div>

  <div id="report-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:left; max-width:470px;">
      <div class="modal-title" style="text-align:center;">Coach Dashboard üèÜ</div>
      <div style="display:flex; gap:10px; margin-bottom:12px;">
        <div style="flex:1"><label>In√≠cio</label><input type="date" id="rep-start"></div>
        <div style="flex:1"><label>Fim</label><input type="date" id="rep-end"></div>
      </div>
      <button class="btn-orange btn-sm" onclick="filterReport()"><i class="fas fa-filter"></i> Atualizar</button>
      <div class="card" style="margin-top:12px;">
        <h4 style="color:#666; margin-bottom:10px; font-size:0.85rem; font-weight:900;">Gr√°fico (Consumo x Queima)</h4>
        <div style="height:190px;"><canvas id="chart-report"></canvas></div>
      </div>
      <hr style="margin:15px 0; border-color:rgba(255,255,255,.08);">
      <div class="rep-section-title">Acumulado (Per√≠odo)</div>
      <div class="rep-grid-compact">
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-net-total">0</span><span class="rep-mini-label">Saldo</span></div>
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-prot-total" style="color:var(--blue)">0g</span><span class="rep-mini-label">Prot</span></div>
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-water-total" style="color:var(--blue)">0L</span><span class="rep-mini-label">√Ågua</span></div>
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-sleep-total" style="color:var(--orange)">0.0h</span><span class="rep-mini-label">Sono</span></div>
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-burn-total" style="color:var(--orange)">0</span><span class="rep-mini-label">Queima</span></div>
      </div>
      <div class="rep-section-title">M√©dia Di√°ria</div>
      <div class="rep-grid-compact" style="margin-bottom:14px;">
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-net-avg">0</span><span class="rep-mini-label">Saldo</span></div>
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-prot-avg" style="color:var(--blue)">0g/dia</span><span class="rep-mini-label">Prot</span></div>
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-water-avg" style="color:var(--blue)">0ml/dia</span><span class="rep-mini-label">√Ågua</span></div>
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-sleep-avg" style="color:var(--orange)">0.0h/dia</span><span class="rep-mini-label">Sono</span></div>
        <div class="rep-mini-card"><span class="rep-mini-val" id="rep-burn-avg" style="color:var(--orange)">0</span><span class="rep-mini-label">Queima</span></div>
      </div>
      <h4 style="color:#666; margin-bottom:10px; font-size:0.85rem; font-weight:900;">Extrato Detalhado (Premium)</h4>
      <div id="rep-list" style="max-height:320px; overflow-y:auto; margin-bottom:12px; background:rgba(0,0,0,.25); padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,.08);"></div>
      <button class="btn-blue" onclick="exportReport()"><i class="fas fa-copy"></i> Copiar Relat√≥rio</button>
      <button class="btn-outline" style="margin-top:10px" onclick="closeModal('report-modal')">Fechar</button>
    </div>
  </div>

  <div id="modal-food" class="modal-overlay hidden"><div class="modal-box" style="text-align:left;"><div class="modal-title" id="food-modal-title">Novo Alimento</div><p id="learn-text" class="modal-msg" style="text-align:center; font-size:0.8rem; color:#888;">Insira para 1 unidade ou 100g</p><label>Calorias (kcal)</label><input type="number" id="food-cal"><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;"><div><label>Prot</label><input type="number" id="food-prot"></div><div><label>Carb</label><input type="number" id="food-carb"></div><div><label>Gord</label><input type="number" id="food-fat"></div></div><button class="btn-orange" onclick="saveFood()">Salvar Alimento</button><button class="btn-outline" style="margin-top:10px" onclick="closeModal('modal-food')">Cancelar</button></div></div>
  <div id="modal-manage-foods" class="modal-overlay hidden"><div class="modal-box"><div class="modal-title">Meus Alimentos</div><div style="max-height:300px; overflow-y:auto; text-align:left;" id="food-list-render"></div><button class="btn-outline" style="margin-top:15px;" onclick="closeModal('modal-manage-foods')">Fechar</button></div></div>
  <div id="modal-exercises" class="modal-overlay hidden"><div class="modal-box" style="text-align:left; max-width:400px;"><div class="modal-title" id="ex-modal-title">Editar Ficha</div><div style="background:#000; padding:10px; border-radius:14px; margin-bottom:15px; border:1px solid rgba(255,255,255,.08);"><label>Adicionar Exerc√≠cio</label><input type="text" id="new-ex-name" style="margin-bottom:5px;"><div style="display:flex; gap:5px;"><input type="number" id="new-ex-sets" placeholder="S√©ries" style="flex:1"><input type="number" id="new-ex-reps" placeholder="Reps" style="flex:1"><button class="btn-blue btn-sm" onclick="addExerciseToGroup()">Add</button></div></div><div style="max-height:220px; overflow-y:auto; margin-bottom:10px;"><div id="ex-list-render"></div></div><button class="btn-outline" onclick="closeModal('modal-exercises'); renderApp();">Fechar</button></div></div>
  <div id="modal-tabata" class="modal-overlay hidden"><div class="modal-box" style="text-align:left;"><div class="modal-title" id="tabata-title">Montar Tabata</div><div style="background:#000; padding:10px; border-radius:14px; margin-bottom:15px; border:1px solid rgba(255,255,255,.08);"><label>Exerc√≠cio</label><input type="text" id="tabata-name" style="margin-bottom:5px;"><div style="display:flex; gap:5px;"><input type="number" id="tabata-min" placeholder="Min" style="flex:1"><button class="btn-blue btn-sm" onclick="addTabataItem()">Inserir</button></div></div><div style="max-height:150px; overflow-y:auto; margin-bottom:10px;"><div id="tabata-list-render"></div></div><div style="text-align:right; margin-bottom:10px; color:#aaa; font-size:0.8rem;">Total Estimado: <strong style="color:var(--orange)" id="tabata-total-kcal">0</strong> kcal</div><button class="btn-orange" onclick="finishTabata()">Salvar Tabata</button><button class="btn-outline" style="margin-top:10px" onclick="closeModal('modal-tabata')">Cancelar</button></div></div>
  <div id="prompt-modal" class="modal-overlay hidden"><div class="modal-box"><div id="pm-title" class="modal-title">Entrada</div><input type="text" id="pm-input" placeholder="..."><div style="display:flex; gap:10px; margin-top:15px;"><button class="btn-outline" onclick="closePromptModal()">Cancelar</button><button id="pm-btn-ok" class="btn-orange">Confirmar</button></div></div></div>

  <div id="modal-physical" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:left;">
      <div class="modal-title">üìè Avalia√ß√£o F√≠sica</div>
      <div class="modal-section-title">Dobras Cut√¢neas (mm)</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>Peitoral</label><input type="number" id="bio-dc-peitoral"></div>
        <div><label>Axilar M√©dia</label><input type="number" id="bio-dc-axilar"></div>
        <div><label>Tr√≠ceps</label><input type="number" id="bio-dc-triceps"></div>
        <div><label>Subescapular</label><input type="number" id="bio-dc-subescapular"></div>
        <div><label>Abd√¥men</label><input type="number" id="bio-dc-abdomen"></div>
        <div><label>Supra-il√≠aca</label><input type="number" id="bio-dc-suprailiaca"></div>
        <div><label>Coxa</label><input type="number" id="bio-dc-coxa"></div>
      </div>
      <div class="modal-section-title" style="margin-top:15px;">Perimetria (cm)</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>T√≥rax</label><input type="number" id="bio-p-torax"></div>
        <div><label>Cintura</label><input type="number" id="bio-p-cintura"></div>
        <div><label>Abd√¥men</label><input type="number" id="bio-p-abdomen"></div>
        <div><label>Quadril</label><input type="number" id="bio-p-quadril"></div>
        <div><label>Bra√ßo Dir.</label><input type="number" id="bio-p-braco-d"></div>
        <div><label>Bra√ßo Esq.</label><input type="number" id="bio-p-braco-e"></div>
        <div><label>Antebra√ßo D.</label><input type="number" id="bio-p-antebraco-d"></div>
        <div><label>Antebra√ßo E.</label><input type="number" id="bio-p-antebraco-e"></div>
        <div><label>Coxa Dir.</label><input type="number" id="bio-p-coxa-d"></div>
        <div><label>Coxa Esq.</label><input type="number" id="bio-p-coxa-e"></div>
        <div><label>Panturrilha D.</label><input type="number" id="bio-p-panturrilha-d"></div>
        <div><label>Panturrilha E.</label><input type="number" id="bio-p-panturrilha-e"></div>
      </div>
      <div style="margin-top:16px;"><label>Peso Atual (kg)</label><input type="number" id="bio-current-weight"></div>
      <button class="btn-red" onclick="savePhysicalAssessment()">Calcular e Salvar</button>
      <button class="btn-outline" style="margin-top:10px" onclick="closeModal('modal-physical')">Cancelar</button>
    </div>
  </div>

  <div id="modal-medical" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:left;">
      <div class="modal-title">ü©∏ Exames M√©dicos</div>
      <div class="modal-section-title">Hormonal</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>Testo Total (ng/dL)</label><input type="number" id="med-testo-t"></div>
        <div><label>Testo Livre (ng/dL)</label><input type="number" id="med-testo-l"></div>
        <div><label>Estradiol (pg/mL)</label><input type="number" id="med-estradiol"></div>
      </div>
      <div class="modal-section-title" style="margin-top:15px;">Lip√≠dico & Glic√™mico</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>Glicose Jejum</label><input type="number" id="med-glicose"></div>
        <div><label>HbA1c (%)</label><input type="number" id="med-hba1c"></div>
        <div><label>LDL</label><input type="number" id="med-ldl"></div>
        <div><label>HDL</label><input type="number" id="med-hdl"></div>
        <div><label>Triglicer√≠deos</label><input type="number" id="med-trig"></div>
      </div>
      <div class="modal-section-title" style="margin-top:15px;">Hep√°tico & Renal</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div><label>TGO</label><input type="number" id="med-tgo"></div>
        <div><label>TGP</label><input type="number" id="med-tgp"></div>
        <div><label>Creatinina</label><input type="number" id="med-creatinina"></div>
      </div>
      <button class="btn-blue" style="margin-top:15px" onclick="saveMedicalAssessment()">Salvar</button>
      <button class="btn-outline" style="margin-top:10px" onclick="closeModal('modal-medical')">Cancelar</button>
    </div>
  </div>

  <div id="modal-history" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:left; max-width:400px;">
      <div class="modal-title">üìÇ Hist√≥rico Completo</div>
      <div id="history-list" style="max-height:300px; overflow-y:auto;"></div>
      <button class="btn-outline" style="margin-top:15px;" onclick="closeModal('modal-history')">Fechar</button>
    </div>
  </div>

  <div id="modal-evolution" class="modal-overlay hidden">
    <div class="modal-box" style="max-width:500px;">
      <div class="modal-title">üìà Painel de Evolu√ß√£o PRO</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px; text-align:left;">
        <div><label>Data Inicial (A)</label><select id="evo-date-a" onchange="compareEvolution()"></select></div>
        <div><label>Data Final (B)</label><select id="evo-date-b" onchange="compareEvolution()"></select></div>
      </div>
      <div id="evo-results-container" class="hidden">
        <div class="card" style="text-align:left;border-left:4px solid var(--red-pro);">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; color:var(--red-pro);"><i class="fas fa-brain"></i> <strong>MENTOR IQ CL√çNICO</strong></div>
          <div id="evo-mentor-msg" style="font-size:0.85rem; line-height:1.5; color:#ddd;"></div>
        </div>
        <div class="modal-section-title">Composi√ß√£o Corporal</div>
        <table style="width:100%; font-size:0.85rem; border-collapse:collapse; margin-bottom:20px;">
          <thead><tr><th style="text-align:left;color:#666;padding:6px;border-bottom:1px solid rgba(255,255,255,.1);">Item</th><th style="text-align:left;color:#666;padding:6px;border-bottom:1px solid rgba(255,255,255,.1);">Data A</th><th style="text-align:left;color:#666;padding:6px;border-bottom:1px solid rgba(255,255,255,.1);">Data B</th><th style="text-align:left;color:#666;padding:6px;border-bottom:1px solid rgba(255,255,255,.1);">Delta</th></tr></thead>
          <tbody id="evo-table-body-comp"></tbody>
        </table>
      </div>
      <button class="btn-outline" style="margin-top:15px" onclick="closeModal('modal-evolution')">Fechar</button>
    </div>
  </div>

  <script>
    const DEFAULT_DB = {
      user: { name: "King", pin: "0000", age: 25, height: 175, weight: 75, wingspan: 175, sex: 'm', goal: "Alta Performance", photo: null, autoTargets: true },
      goals: { kcal: 2500, p: 150, c: 250, f: 80 },
      water: { current: 0, goal: 3000, date: "" },
      sleep: { current: 0, goal: 8, date: "" },
      logs: [],
      foods: { "ovo":{kcal:75,p:6,c:0.6,f:5}, "frango":{kcal:165,p:31,c:0,f:3.6}, "arroz":{kcal:130,p:2.5,c:28,f:0.3}, "azeite":{kcal:119,p:0,c:0,f:13.5} },
      workouts: [],
      assessments: []
    };

    let db = JSON.parse(JSON.stringify(DEFAULT_DB));
    let appDate = "";
    let chartInst = null;
    let reportChartInst = null;
    let currentEditingGroupId = null;
    let currentTabataList = [];
    let currentMeal = "Caf√© da Manh√£";
    let tempFoodName = "";
    let promptCallback = null;
    let latestPhysData = null;
    let viewingAssessId = null;

    function getToday(){ const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function save(){ localStorage.setItem('reinah_v6_5', JSON.stringify(db)); }
    function toast(m,t){ const d=document.createElement('div'); d.className='toast'; if(t==='err') d.style.borderColor='var(--red-pro)'; d.innerHTML=m; document.getElementById('toast-box').appendChild(d); setTimeout(()=>d.remove(),3000); }
    function setTxt(id, val){ const el=document.getElementById(id); if(el) el.innerText = val; }

    function renderReportChart(dailyData, bmr){
      const canvas = document.getElementById('chart-report');
      if(!canvas) return;
      const labels = Object.keys(dailyData || {}).sort();
      const consumo = []; const queima = [];
      labels.forEach(d=>{ const day = dailyData[d] || {in:0,out:0}; consumo.push(day.in || 0); queima.push((day.out || 0) + (bmr || 0)); });
      const prettyLabels = labels.map(d=>{ const [y,m,dd] = d.split('-'); return `${dd}/${m}`; });
      if(reportChartInst){ reportChartInst.data.labels = prettyLabels; reportChartInst.data.datasets[0].data = consumo; reportChartInst.data.datasets[1].data = queima; reportChartInst.update(); return; }
      const ctx = canvas.getContext('2d');
      reportChartInst = new Chart(ctx,{ type:'line', data:{ labels: prettyLabels, datasets:[ { label:'Consumo', data: consumo, tension:0.35 }, { label:'Queima', data: queima, tension:0.35 } ] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#666' }, grid:{ color:'#222' } }, y:{ ticks:{ color:'#666' }, grid:{ color:'#222' } } } } });
    }

    window.onload = function(){
      appDate = getToday();
      const saved = localStorage.getItem('reinah_v6_5');
      if(saved){ try{ db = JSON.parse(saved); if(!db.user.wingspan) db.user.wingspan = db.user.height; if(!db.sleep) db.sleep = { current:0, goal:8, date:"" }; if(!db.sleep.goal) db.sleep.goal = 8; checkDayReset(); }catch(e){ db = JSON.parse(JSON.stringify(DEFAULT_DB)); } }else{ save(); toast("Bem-vindo! PIN: 0000"); }
      if(!db.assessments) db.assessments = [];
      if(!db.sleep) db.sleep = { current:0, goal:8, date:"" };
      if(!db.sleep.goal) db.sleep.goal = 8;
      document.getElementById('prof-pic-input').addEventListener('change', processPhoto);
      updateDatalist(); renderHeaderPhoto(); renderHome();
    };

    function checkDayReset(){
      const t = getToday();
      if(db.water.date !== t){ const exists = db.logs.find(l => l.date === db.water.date && l.type === 'water'); if(!exists && db.water.current > 0){ db.logs.push({ id: Date.now(), date: db.water.date, type:'water', val: db.water.current, desc:'üíß Hidrata√ß√£o Final' }); } db.water.current = 0; db.water.date = t; }
      if(!db.sleep) db.sleep = { current:0, goal:8, date:"" };
      if(db.sleep.date !== t){ const existsS = db.logs.find(l => l.date === db.sleep.date && l.type === 'sleep'); if(!existsS && (parseFloat(db.sleep.current)||0) > 0){ db.logs.push({ id: Date.now() + 1, date: db.sleep.date, type:'sleep', val: parseFloat(db.sleep.current)||0, desc:'üò¥ Sono Final' }); } db.sleep.current = 0; db.sleep.date = t; }
      save();
    }

    function nav(tab, el){
      if(tab === 'tech'){ document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById('tab-tech').classList.add('active'); return; }
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById('tab-'+tab).classList.add('active');
      if(el){ document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active')); el.classList.add('active'); }
      if(tab==='home') renderHome(); if(tab==='diet') renderDietLog(); if(tab==='workout') renderApp(); if(tab==='profile') loadProfileData();
    }

    function doLogin(){ if(document.getElementById('login-pin').value === db.user.pin){ document.getElementById('screen-lock').classList.remove('active'); nav('home', document.querySelector('.dock-item')); }else toast('PIN Incorreto','err'); }
    function emergencyReset(){ sysConfirm('Resetar TUDO para o padr√£o? PIN voltar√° a ser 0000.', resetSystem); }
    function resetSystem(){ localStorage.removeItem('reinah_v6_5'); location.reload(); }

    function renderHome(){
      document.getElementById('global-date-display').innerText = (appDate === getToday()) ? "Hoje" : appDate.split('-').reverse().join('/');
      document.getElementById('home-greeting').innerText = `Ol√°, ${db.user.name}`;
      renderHeaderPhoto();
      let waterVal = 0;
      if(appDate === getToday()) waterVal = db.water.current; else{ const wLog = db.logs.find(l => l.date === appDate && l.type === 'water'); waterVal = wLog ? wLog.val : 0; }
      document.getElementById('water-display-compact').innerText = `${waterVal} / ${db.water.goal}ml`;
      if(!db.sleep) db.sleep = { current:0, goal:8, date:getToday() };
      if(!db.sleep.goal) db.sleep.goal = 8;
      let sleepVal = 0;
      if(appDate === getToday()) sleepVal = parseFloat(db.sleep.current)||0; else{ const sLog = db.logs.find(l => l.date === appDate && l.type === 'sleep'); sleepVal = sLog ? (parseFloat(sLog.val)||0) : 0; }
      const sleepGoal = parseFloat(db.sleep.goal)||8;
      document.getElementById('sleep-display-compact').innerText = `${sleepVal.toFixed(1)} / ${sleepGoal.toFixed(1)}h`;
      const logs = db.logs.filter(l => l.date === appDate);
      let inVal=0, outActive=0, currentP=0, currentC=0, currentF=0;
      logs.forEach(l=>{ if(l.type==='in'){ inVal += parseFloat(l.val)||0; currentP += parseFloat(l.p)||0; currentC += parseFloat(l.c)||0; currentF += parseFloat(l.f)||0; }else if(l.type==='out'){ outActive += parseFloat(l.val)||0; } });
      const g = db.goals; const u = db.user;
      const bmr = Math.round(u.sex==='m' ? (88.36+(13.4*u.weight)+(4.8*u.height)-(5.7*u.age)) : (447.6+(9.2*u.weight)+(3.1*u.height)-(4.3*u.age)));
      const totalBurn = outActive + bmr; const net = inVal - totalBurn; const balKcal = g.kcal - inVal;
      const tbody = document.getElementById('macro-table-body');
      tbody.innerHTML = `<tr><td style="text-align:left; color:var(--blue)">Prote√≠na</td><td>${g.p}g</td><td class="macro-val">${Math.round(currentP)}g</td><td class="macro-bal ${g.p-currentP>0?'bal-neg':'bal-pos'}">${Math.round(g.p-currentP)}g</td></tr><tr><td style="text-align:left; color:var(--orange)">Carbo</td><td>${g.c}g</td><td class="macro-val">${Math.round(currentC)}g</td><td class="macro-bal ${g.c-currentC>0?'bal-neg':'bal-pos'}">${Math.round(g.c-currentC)}g</td></tr><tr><td style="text-align:left; color:#ccc">Gordura</td><td>${g.f}g</td><td class="macro-val">${Math.round(currentF)}g</td><td class="macro-bal ${g.f-currentF>0?'bal-neg':'bal-pos'}">${Math.round(g.f-currentF)}g</td></tr><tr><td style="text-align:left; color:#fff">Kcal</td><td>${g.kcal}</td><td class="macro-val">${Math.round(inVal)}</td><td class="macro-bal ${balKcal>0?'bal-neg':'bal-exc'}">${Math.round(balKcal)}</td></tr>`;
      updateChart(inVal, totalBurn);
      const msg = document.getElementById('mentor-msg');
      if(net > 200) msg.innerHTML = `üõë <strong>Super√°vit:</strong> +${Math.round(net)}kcal no dia.`; else if(net < -200) msg.innerHTML = `üî• <strong>D√©ficit:</strong> -${Math.abs(Math.round(net))}kcal no dia.`; else msg.innerHTML = "‚úÖ <strong>Equil√≠brio:</strong> Entradas e sa√≠das iguais.";
    }

    function addWater(q){ const today = getToday(); if(appDate === today){ db.water.current += q; if(db.water.current < 0) db.water.current = 0; }else{ let log = db.logs.find(l => l.date === appDate && l.type === 'water'); if(log){ log.val += q; if(log.val < 0) log.val = 0; }else{ if(q > 0) db.logs.push({id: Date.now(), date: appDate, type:'water', val:q, desc:'üíß Hidrata√ß√£o Manual'}); } } save(); renderHome(); }
    function addSleep(q){ const today = getToday(); if(!db.sleep) db.sleep = { current:0, goal:8, date:today }; if(!db.sleep.goal) db.sleep.goal = 8; if(appDate === today){ db.sleep.current = (parseFloat(db.sleep.current)||0) + q; if(db.sleep.current < 0) db.sleep.current = 0; }else{ let log = db.logs.find(l => l.date === appDate && l.type === 'sleep'); if(log){ log.val = (parseFloat(log.val)||0) + q; if(log.val < 0) log.val = 0; }else{ if(q > 0) db.logs.push({id: Date.now()+Math.random(), date: appDate, type:'sleep', val:q, desc:'üò¥ Sono Manual'}); } } save(); renderHome(); }

    function updateChart(i,g){ const ctx = document.getElementById('chart-main'); if(!ctx) return; if(chartInst){ chartInst.data.datasets[0].data = [i]; chartInst.data.datasets[1].data = [g]; chartInst.update(); }else{ chartInst = new Chart(ctx.getContext('2d'),{ type:'bar', data:{ labels:['Hoje'], datasets:[ {label:'Entrada (Comida)', data:[i], backgroundColor:'#007bff', borderRadius:10}, {label:'Sa√≠da (Total)', data:[g], backgroundColor:'#ff6600', borderRadius:10} ] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{grid:{color:'#222'},ticks:{color:'#555'}}} } }); } }
    function changeGlobalDate(offset){ const c = new Date(appDate + "T12:00:00"); c.setDate(c.getDate() + offset); appDate = `${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,'0')}-${String(c.getDate()).padStart(2,'0')}`; renderHome(); if(document.getElementById('tab-diet').classList.contains('active')) renderDietLog(); if(document.getElementById('tab-workout').classList.contains('active')) renderLogsToday(); }

    // DIET & WORKOUT & PROFILE (MANTIDOS ORIGINAIS DO SEU C√ìDIGO)
    function renderDietLog(){ document.getElementById('diet-date-display').innerText = (appDate === getToday()) ? "Hoje" : appDate.split('-').reverse().join('/'); const box = document.getElementById('diet-log-container'); box.innerHTML=''; const logs = db.logs.filter(l => l.date === appDate && l.type === 'in'); const meals = ['Caf√© da Manh√£','Almo√ßo','Caf√© da Tarde','Jantar','Ceia','Extra']; const grouped = {}; logs.forEach(l=>{ const m=l.meal||'Extra'; if(!grouped[m]) grouped[m]=[]; grouped[m].push(l); }); meals.forEach(m=>{ if(grouped[m]){ box.innerHTML += `<div style="color:var(--orange); font-size:0.85rem; font-weight:900; margin:15px 0 8px 0; border-bottom:1px solid rgba(255,255,255,.06); padding-bottom:6px;">${m.toUpperCase()}</div>`; grouped[m].forEach(l=>{ box.innerHTML += ` <div style="display:flex; justify-content:space-between; padding:12px 0; font-size:0.92rem; border-bottom:1px solid rgba(255,255,255,.05); align-items:center;"> <div style="flex:1"> <strong>${l.desc}</strong> <div style="font-size:.75rem;color:#666;margin-top:3px;">P:${l.p} C:${l.c} G:${l.f}</div> </div> <div style="display:flex; align-items:center;"> <strong style="color:var(--blue); margin-right:10px;">${l.val}</strong> <div style="display:flex; gap:14px; align-items:center; margin-left:10px;"> <i class="fas fa-pencil-alt" style="color:var(--blue); cursor:pointer;" onclick="editDietLog(${l.id})"></i> <i class="fas fa-trash" style="color:var(--red); cursor:pointer;" onclick="deleteLog(${l.id})"></i> </div> </div> </div>`; }); } }); if(logs.length === 0){ box.innerHTML = `<div style="text-align:center; color:#444; margin-top:20px; font-size:0.95rem;">Nenhum registro para esta data</div>`; } }
    function addDiet(){ const name = document.getElementById('diet-food-name').value.toLowerCase().trim(); const qty = parseFloat(document.getElementById('diet-food-qty').value) || 1; if(!name) return; if(db.foods[name]){ const f = db.foods[name]; db.logs.push({ id: Date.now()+Math.random(), date: appDate, type:'in', val: Math.round(f.kcal*qty), desc: `${qty}x ${name}`, meal: currentMeal, p:(f.p*qty).toFixed(1), c:(f.c*qty).toFixed(1), f:(f.f*qty).toFixed(1), origName:name, origQty:qty }); save(); toast(`+${Math.round(f.kcal*qty)} kcal`); document.getElementById('diet-food-name').value=''; document.getElementById('diet-food-qty').value='1'; renderDietLog(); }else{ tempFoodName = name; document.getElementById('food-modal-title').innerText = `Novo: ${name}`; document.getElementById('food-cal').value=''; document.getElementById('food-prot').value=''; document.getElementById('food-carb').value=''; document.getElementById('food-fat').value=''; openModal('modal-food'); } }
    function saveFood(){ const k = parseFloat(document.getElementById('food-cal').value); const p = parseFloat(document.getElementById('food-prot').value)||0; const c = parseFloat(document.getElementById('food-carb').value)||0; const f = parseFloat(document.getElementById('food-fat').value)||0; if(k){ db.foods[tempFoodName] = {kcal:k, p:p, c:c, f:f}; save(); updateDatalist(); closeModal('modal-food'); if(document.getElementById('tab-diet').classList.contains('active')) addDiet(); else{ toast("Alimento salvo!"); openManageFoods(); } } }
    function updateDatalist(){ const dl = document.getElementById('food-datalist'); dl.innerHTML=''; Object.keys(db.foods).forEach(k=> dl.innerHTML += `<option value="${k}">`); }
    function selMeal(btn, m){ document.querySelectorAll('.meal-btn').forEach(b=>b.classList.remove('selected')); btn.classList.add('selected'); currentMeal = m; }
    function deleteLog(id){ db.logs = db.logs.filter(l=>l.id !== id); save(); if(document.getElementById('tab-diet').classList.contains('active')) renderDietLog(); else renderLogsToday(); }
    function editDietLog(id){ const item = db.logs.find(l=>l.id===id); if(!item) return; sysPrompt(`Nova quantidade:`, (newQty)=>{ const qtd = parseFloat(newQty); if(qtd && qtd > 0 && db.foods[item.origName]){ const f = db.foods[item.origName]; item.origQty = qtd; item.val = Math.round(f.kcal*qtd); item.desc = `${qtd}x ${item.origName}`; item.p = (f.p*qtd).toFixed(1); item.c = (f.c*qtd).toFixed(1); item.f = (f.f*qtd).toFixed(1); save(); renderDietLog(); toast('Atualizado!'); } }); }
    function openManageFoods(){ const list = document.getElementById('food-list-render'); list.innerHTML=''; Object.keys(db.foods).sort().forEach(key=>{ const f = db.foods[key]; list.innerHTML += ` <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,.06); align-items:center;"> <div> <strong style="text-transform:capitalize">${key}</strong><br> <small style="color:#666">${f.kcal}kcal</small> </div> <div> <i class="fas fa-pencil-alt" style="color:var(--blue); cursor:pointer; margin-right:15px;" onclick="editBaseFood('${key}')"></i> <i class="fas fa-trash" style="color:var(--red); cursor:pointer;" onclick="deleteFood('${key}')"></i> </div> </div>`; }); openModal('modal-manage-foods'); }
    function editBaseFood(key){ const f = db.foods[key]; if(!f) return; closeModal('modal-manage-foods'); tempFoodName = key; document.getElementById('food-modal-title').innerText = `Editar: ${key}`; document.getElementById('food-cal').value = f.kcal; document.getElementById('food-prot').value = f.p; document.getElementById('food-carb').value = f.c; document.getElementById('food-fat').value = f.f; openModal('modal-food'); }
    function deleteFood(key){ sysConfirm("Apagar "+key+"?", ()=>{ delete db.foods[key]; save(); openManageFoods(); updateDatalist(); }); }

    function renderApp(){ document.getElementById('workout-date-display').innerText = (appDate === getToday()) ? "Hoje" : appDate.split('-').reverse().join('/'); const area = document.getElementById('workout-render-area'); area.innerHTML=''; db.workouts.forEach(w=>{ let items = ''; w.exercises.forEach(ex=>{ items += ` <div class="ex-check-item group-${w.id}" data-sets="${ex.sets}" onclick="toggleCheck(this, ${w.id})" style="display:flex;align-items:center;gap:10px;padding:12px;background:#0a0a0a;border-radius:14px;margin-bottom:8px;border:1px solid rgba(255,255,255,.06);transition:.2s;"> <div class="ex-check-box" style="width:24px;height:24px;border:2px solid #444;border-radius:8px;display:flex;justify-content:center;align-items:center;color:transparent;transition:.2s;flex-shrink:0;"> <i class="fas fa-check"></i> </div> <div>${ex.sets}x${ex.reps} <strong>${ex.name}</strong></div> </div>`; }); const openClass = w.isOpen ? '' : 'collapsed'; area.innerHTML += ` <div class="card" style="border-left:3px solid var(--blue);" id="workout-card-${w.id}"> <div class="workout-body ${openClass}" style="overflow:hidden; transition:max-height .3s ease-out;"> ${items || '<small style="color:#666; display:block; padding:10px;">Vazio.</small>'} <button class="btn-orange" id="btn-work-${w.id}" style="margin-top:15px;" onclick="finishWorkout(${w.id}, '${w.name}')">Concluir Treino (~0kcal)</button> <hr style="border:0; border-top:1px solid rgba(255,255,255,.06); margin:10px 0;"> </div> <div class="workout-header" onclick="toggleWorkout(${w.id})" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer; padding-top:10px;"> <strong style="font-size:1.05rem;">${w.name}</strong> <div style="display:flex; align-items:center;"> <i class="fas fa-pencil-alt" style="color:var(--blue); margin-right:15px;" onclick="event.stopPropagation(); openEditGroup(${w.id})"></i> <i class="fas fa-trash" style="color:var(--red); margin-right:10px;" onclick="event.stopPropagation(); deleteGroup(${w.id})"></i> <i class="fas fa-chevron-up" style="transition:.3s;font-size:.8rem;color:#666;margin-left:10px;"></i> </div> </div> </div>`; }); renderLogsToday(); }
    function renderLogsToday(){ const logArea = document.getElementById('workout-log-today'); logArea.innerHTML=''; const logs = db.logs.filter(l=>l.date===appDate && l.type==='out'); logs.forEach(l=>{ logArea.innerHTML += ` <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.06); border-radius:14px; margin-bottom:8px;"> <span>${l.desc}</span> <div style="display:flex; align-items:center;"> <strong style="color:var(--orange); margin-right:10px;">-${l.val}</strong> <i class="fas fa-trash" style="color:var(--red); font-size:0.95rem; cursor:pointer;" onclick="deleteLog(${l.id})"></i> </div> </div>`; }); if(logs.length === 0){ logArea.innerHTML = `<div style="text-align:center; color:#444; margin-top:20px; font-size:0.95rem;">Nenhum treino nesta data</div>`; } }
    function logWorkout(cal, desc){ db.logs.push({id: Date.now()+Math.random(), date: appDate, type:'out', val: cal, desc: desc}); save(); toast("Treino Pago!"); renderApp(); }
    function setCardio(t){ document.getElementById('cardio-desc').value=t; document.getElementById('cardio-min').focus(); calcCardioPreview(); }
    function calcCardioPreview(){ const min = parseFloat(document.getElementById('cardio-min').value)||0; const desc = (document.getElementById('cardio-desc').value||"").toLowerCase(); let met = 7; if(desc.includes('luta') || desc.includes('boxe')) met = 10; if(desc.includes('caminhada')) met = 4; const burned = Math.round(met * db.user.weight * (min/60)); document.getElementById('cardio-cal-preview').value = burned; }
    function addCardio(){ const d = document.getElementById('cardio-desc').value||'Cardio'; const m = parseFloat(document.getElementById('cardio-min').value); const cal = parseFloat(document.getElementById('cardio-cal-preview').value); if(m && cal){ db.logs.push({id: Date.now()+Math.random(), date: appDate, type:'out', val: cal, desc:`üèÉ ${d} (${m}min)`}); save(); toast("Treino Pago!"); renderApp(); document.getElementById('cardio-cal-preview').value=''; document.getElementById('cardio-min').value=''; document.getElementById('cardio-desc').value=''; } }
    function createNewGroup(){ sysPrompt("Nome da Ficha:", (n)=>{ if(n){ db.workouts.push({id:Date.now(), name:n, exercises:[], isOpen:true}); save(); renderApp(); } }); }
    function deleteGroup(id){ sysConfirm("Excluir ficha?", ()=>{ db.workouts = db.workouts.filter(w=>w.id!==id); save(); renderApp(); }); }
    function openEditGroup(id){ currentEditingGroupId = id; const g = db.workouts.find(w=>w.id===id); if(g){ document.getElementById('ex-modal-title').innerText = `Ficha: ${g.name}`; renderExList(); openModal('modal-exercises'); } }
    function addExerciseToGroup(){ const n = document.getElementById('new-ex-name').value; const s = document.getElementById('new-ex-sets').value; const r = document.getElementById('new-ex-reps').value; if(n && s && r && currentEditingGroupId){ const grp = db.workouts.find(w=>w.id===currentEditingGroupId); if(grp){ grp.exercises.push({name:n, sets:s, reps:r}); save(); renderExList(); document.getElementById('new-ex-name').value=''; } } }
    function renderExList(){ const list = document.getElementById('ex-list-render'); list.innerHTML=''; const g = db.workouts.find(w=>w.id===currentEditingGroupId); if(g){ g.exercises.forEach((ex,idx)=>{ list.innerHTML += ` <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,.06);"> <span>${ex.sets}x${ex.reps} ${ex.name}</span> <i class="fas fa-trash" style="color:var(--red); cursor:pointer;" onclick="delEx(${idx})"></i> </div>`; }); } }
    function delEx(idx){ const grp = db.workouts.find(w=>w.id===currentEditingGroupId); if(grp){ grp.exercises.splice(idx,1); save(); renderExList(); } }
    function toggleWorkout(id){ const w = db.workouts.find(x=>x.id===id); if(w){ w.isOpen = !w.isOpen; save(); renderApp(); } }
    function toggleCheck(el, wid){ el.classList.toggle('checked'); const box = el.querySelector('.ex-check-box'); if(el.classList.contains('checked')){ el.style.opacity = .72; el.style.borderColor = 'rgba(0,230,118,.6)'; if(box){ box.style.background = 'var(--green)'; box.style.borderColor = 'var(--green)'; box.style.color = '#000'; } }else{ el.style.opacity = 1; el.style.borderColor = 'rgba(255,255,255,.06)'; if(box){ box.style.background = 'transparent'; box.style.borderColor = '#444'; box.style.color = 'transparent'; } } updateButtonCal(wid); }
    function updateButtonCal(wid){ const checks = document.querySelectorAll(`.group-${wid}.checked`); let sets = 0; checks.forEach(c => { sets += parseInt(c.getAttribute('data-sets'))||0; }); const cal = Math.round((sets*6) + (sets>5 ? 80:0)); const btn = document.getElementById(`btn-work-${wid}`); if(btn) btn.innerText = `Concluir Treino (~${cal}kcal)`; }
    function finishWorkout(wid, name){ const checks = document.querySelectorAll(`.group-${wid}.checked`); let sets = 0; checks.forEach(c => sets += parseInt(c.getAttribute('data-sets'))||0); if(sets === 0){ toast("Selecione exerc√≠cios!","err"); return; } const cal = Math.round((sets*6) + (sets>5 ? 80:0)); logWorkout(cal, name); document.querySelectorAll(`.group-${wid}`).forEach(c => c.classList.remove('checked')); updateButtonCal(wid); }
    function openTabata(){ currentTabataList = []; renderTabataList(); document.getElementById('tabata-name').value=''; document.getElementById('tabata-min').value=''; openModal('modal-tabata'); }
    function addTabataItem(){ const name = document.getElementById('tabata-name').value; const min = parseFloat(document.getElementById('tabata-min').value); if(!name || !min) return; let burnRate = 8; const n = name.toLowerCase(); if(n.includes('corda')||n.includes('corrida')||n.includes('saco')||n.includes('boxe')) burnRate = 12; if(n.includes('polichinelo')||n.includes('burpee')||n.includes('agacha')) burnRate = 10; const kcal = Math.round(min * burnRate); currentTabataList.push({name, min, kcal}); renderTabataList(); document.getElementById('tabata-name').value=''; document.getElementById('tabata-min').value=''; }
    function renderTabataList(){ const div = document.getElementById('tabata-list-render'); div.innerHTML=''; let total = 0; currentTabataList.forEach((item)=>{ total += item.kcal; div.innerHTML += ` <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid rgba(255,255,255,.06); font-size:0.92rem;"> <span>${item.min}min ${item.name}</span> <span style="color:var(--orange); font-weight:900;">~${item.kcal}kcal</span> </div>`; }); document.getElementById('tabata-total-kcal').innerText = total; }
    function finishTabata(){ if(currentTabataList.length === 0) return; let totalKcal = 0; let descList = []; currentTabataList.forEach(item=>{ totalKcal += item.kcal; descList.push(`${item.name} (${item.min}')`); }); const finalDesc = "ü•ä Tabata: " + descList.join(', '); logWorkout(totalKcal, finalDesc); closeModal('modal-tabata'); }
    function loadProfileData(){ const u = db.user; document.getElementById('prof-name').value=u.name; document.getElementById('prof-age').value=u.age; document.getElementById('prof-height').value=u.height; document.getElementById('prof-weight').value=u.weight; document.getElementById('prof-wingspan').value=u.wingspan||u.height; document.getElementById('prof-sex').value=u.sex; document.getElementById('prof-goal').value=u.goal; document.getElementById('prof-name-disp').innerText = u.name; document.getElementById('prof-goal-disp').innerText = u.goal; renderHeaderPhoto(); document.getElementById('prof-auto-switch').checked = u.autoTargets; toggleAutoTargets(); if(!u.autoTargets){ document.getElementById('prof-goal-kcal').value = db.goals.kcal; document.getElementById('prof-goal-p').value = db.goals.p; document.getElementById('prof-goal-c').value = db.goals.c; document.getElementById('prof-goal-f').value = db.goals.f; }else calculateGoals(true); const phys = db.assessments.filter(a=>a.type==='physical').sort((a,b)=>b.id-a.id); if(phys.length>0){ latestPhysData = phys[0]; document.getElementById('last-assess-date').innerText = latestPhysData.date.split('-').reverse().join('/'); document.getElementById('last-assess-w').innerText = latestPhysData.data.weight + 'kg'; document.getElementById('last-assess-bf').innerText = latestPhysData.data.bfPercent.toFixed(1) + '%'; document.getElementById('last-assess-lean').innerText = latestPhysData.data.leanMass.toFixed(1) + 'kg'; document.getElementById('latest-assessment-card').classList.remove('hidden'); } }
    function saveProfile(){ const u=db.user; u.name=document.getElementById('prof-name').value; u.age=parseFloat(document.getElementById('prof-age').value); u.height=parseFloat(document.getElementById('prof-height').value); u.weight=parseFloat(document.getElementById('prof-weight').value); u.wingspan=parseFloat(document.getElementById('prof-wingspan').value); u.sex=document.getElementById('prof-sex').value; u.goal=document.getElementById('prof-goal').value; u.autoTargets=document.getElementById('prof-auto-switch').checked; if(u.autoTargets){ calculateGoals(); }else{ db.goals.kcal=parseFloat(document.getElementById('prof-goal-kcal').value); db.goals.p=parseFloat(document.getElementById('prof-goal-p').value); db.goals.c=parseFloat(document.getElementById('prof-goal-c').value); db.goals.f=parseFloat(document.getElementById('prof-goal-f').value); save(); } toast("Perfil Atualizado!"); loadProfileData(); }
    function renderHeaderPhoto(){ const u=db.user; const h=document.getElementById('header-avatar'); const p=document.getElementById('profile-avatar-box'); if(u.photo){ h.style.backgroundImage = `url('${u.photo}')`; p.style.backgroundImage = `url('${u.photo}')`; const icon = document.getElementById('avatar-default-icon'); if(icon) icon.style.display='none'; } }
    function triggerPhotoUpload(){ document.getElementById('prof-pic-input').click(); }
    function processPhoto(e){ const file = e.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=function(evt){ const img=new Image(); img.onload=function(){ const c=document.createElement('canvas'); const ctx=c.getContext('2d'); const m=220; let w=img.width,h=img.height; if(w>h){ if(w>m){ h*=m/w; w=m; } } else { if(h>m){ w*=m/h; h=m; } } c.width=w;c.height=h; ctx.drawImage(img,0,0,w,h); db.user.photo=c.toDataURL('image/jpeg',0.85); save(); loadProfileData(); toast("Foto atualizada!"); }; img.src=evt.target.result; }; r.readAsDataURL(file); }
    function toggleAutoTargets(){ const isAuto = document.getElementById('prof-auto-switch').checked; const area = document.getElementById('manual-targets-area'); const inputs = area.querySelectorAll('input'); if(isAuto){ area.style.opacity='0.5'; inputs.forEach(i=>i.setAttribute('disabled','true')); calculateGoals(true); }else{ area.style.opacity='1'; inputs.forEach(i=>i.removeAttribute('disabled')); } }
    function calculateGoals(forceUpdateUI=false){ if(!db.user.autoTargets && !forceUpdateUI) return; const u=db.user; let bmr = Math.round(u.sex==='m' ? (88.36+(13.4*u.weight)+(4.8*u.height)-(5.7*u.age)) : (447.6+(9.2*u.weight)+(3.1*u.height)-(4.3*u.age))); let tdee = Math.round(bmr*1.4); const p = Math.round(u.weight*2.0); const f = Math.round(u.weight*1.0); const kcalProt = p*4; const kcalFat = f*9; const remainingKcal = tdee - (kcalProt + kcalFat); const c = Math.round(remainingKcal/4); if(db.user.autoTargets){ db.goals = {kcal:tdee, p:p, c:c, f:f}; save(); } const kInput = document.getElementById('prof-goal-kcal'); if(kInput){ document.getElementById('prof-goal-kcal').value=tdee; document.getElementById('prof-goal-p').value=p; document.getElementById('prof-goal-c').value=c; document.getElementById('prof-goal-f').value=f; } }
    function openReport(){ const t = getToday(); const past = new Date(); past.setDate(past.getDate()-7); document.getElementById('rep-end').value = t; document.getElementById('rep-start').value = past.toISOString().split('T')[0]; filterReport(); openModal('report-modal'); }
    function filterReport(){ const start = document.getElementById('rep-start').value; const end = document.getElementById('rep-end').value; const list = document.getElementById('rep-list'); list.innerHTML=''; let logs = db.logs.filter(l => l.date >= start && l.date <= end).sort((a,b)=> b.date.localeCompare(a.date)); const today = getToday(); if(today >= start && today <= end){ if(!logs.find(l=>l.date===today && l.type==='water')){ if(db.water.current>0) logs.push({date:today,type:'water',val:db.water.current}); } if(!logs.find(l=>l.date===today && l.type==='sleep')){ if((parseFloat(db.sleep?.current)||0) > 0) logs.push({date:today,type:'sleep',val:parseFloat(db.sleep.current)||0}); } } const daysUnique = [...new Set(logs.map(l=>l.date))]; const daysCount = daysUnique.length || 1; let totalIn=0, totalOutActive=0, totalWater=0, totalProt=0, totalSleep=0; const u = db.user; const bmr = Math.round(u.sex==='m' ? (88.36+(13.4*u.weight)+(4.8*u.height)-(5.7*u.age)) : (447.6+(9.2*u.weight)+(3.1*u.height)-(4.3*u.age))); const dailyData = {}; daysUnique.forEach(d => dailyData[d] = { in:0, out:0, water:0, sleep:0, prot:0, items:[] }); logs.forEach(l=>{ if(!dailyData[l.date]) dailyData[l.date] = { in:0, out:0, water:0, sleep:0, prot:0, items:[] }; if(l.type==='in'){ dailyData[l.date].in += l.val; totalIn += l.val; const p = parseFloat(l.p)||0; totalProt += p; dailyData[l.date].prot += p; dailyData[l.date].items.push(`<span style="color:var(--blue)">+${l.val} ${l.desc}</span>`); }else if(l.type==='out'){ dailyData[l.date].out += l.val; totalOutActive += l.val; dailyData[l.date].items.push(`<span style="color:var(--red)">-${l.val} ${l.desc}</span>`); }else if(l.type==='water'){ dailyData[l.date].water = l.val; totalWater += l.val; }else if(l.type==='sleep'){ const s = parseFloat(l.val)||0; dailyData[l.date].sleep = s; totalSleep += s; } }); const totalBurned = totalOutActive + (daysCount * bmr); const netBalance = totalIn - totalBurned; document.getElementById('rep-net-total').innerText = (netBalance > 0 ? "+" : "") + Math.round(netBalance); document.getElementById('rep-net-total').style.color = netBalance > 0 ? "var(--red)" : "var(--green)"; document.getElementById('rep-prot-total').innerText = Math.round(totalProt) + "g"; document.getElementById('rep-water-total').innerText = (totalWater/1000).toFixed(1) + "L"; document.getElementById('rep-sleep-total').innerText = totalSleep.toFixed(1) + "h"; document.getElementById('rep-burn-total').innerText = "-" + Math.round(totalBurned); document.getElementById('rep-net-avg').innerText = (netBalance/daysCount > 0 ? "+" : "") + Math.round(netBalance/daysCount) + "/dia"; document.getElementById('rep-prot-avg').innerText = Math.round(totalProt / daysCount) + "g/dia"; document.getElementById('rep-water-avg').innerText = Math.round(totalWater / daysCount) + "ml/dia"; document.getElementById('rep-sleep-avg').innerText = (totalSleep / daysCount).toFixed(1) + "h/dia"; document.getElementById('rep-burn-avg').innerText = "-" + Math.round(totalBurned / daysCount) + "/dia"; renderReportChart(dailyData, bmr); if(Object.keys(dailyData).length === 0){ list.innerHTML = ` <div style="text-align:center; padding:20px; color:#666; font-size:0.9rem;"> Nenhum registro de dieta ou treino encontrado neste per√≠odo. </div>`; return; } list.innerHTML = ""; Object.keys(dailyData).sort().reverse().forEach(date=>{ const day = dailyData[date]; const dayNet = (day.in || 0) - ((day.out || 0) + bmr); const dateStr = date.split('-').reverse().join('/'); const waterOk = (day.water || 0) >= (db.water.goal || 3000) ? true : false; const sleepOk = (day.sleep || 0) >= (parseFloat(db.sleep?.goal)||8) ? true : false; const protOk = (day.prot || 0) >= (db.goals?.p || 150) ? true : false; let insight = ""; if(dayNet < -350) insight += `üî• <b>D√©ficit alto</b> (${Math.round(dayNet)}). Excelente para cutting, mas cuide de recupera√ß√£o.<br>`; else if(dayNet < -150) insight += `‚úÖ <b>D√©ficit controlado</b> (${Math.round(dayNet)}). Boa consist√™ncia.<br>`; else if(dayNet <= 150) insight += `‚öñÔ∏è <b>Equil√≠brio</b> (${Math.round(dayNet)}). Dia de manuten√ß√£o.<br>`; else insight += `üõë <b>Super√°vit</b> (+${Math.round(dayNet)}). Bom para ganho, mas aten√ß√£o ao controle.<br>`; const fixes = []; if(!protOk) fixes.push("prote√≠na"); if(!waterOk) fixes.push("√°gua"); if(!sleepOk) fixes.push("sono"); if(fixes.length === 0) insight += `üèÜ <b>Dia completo</b>: macros e h√°bitos bem alinhados.`; else insight += `üéØ Ajuste: melhorar <b>${fixes.join(", ")}</b> para elevar desempenho.`; list.innerHTML += ` <div class="rep-day-card"> <div class="rep-day-header"> <strong>${dateStr}</strong> <span style="font-weight:900; font-size:1.05rem; color:${dayNet > 0 ? 'var(--red)' : 'var(--green)'};"> ${dayNet > 0 ? "+" : ""}${Math.round(dayNet)} </span> </div> <div class="rep-subline"> <span style="color:var(--blue); font-weight:900;">Consumo: ${Math.round(day.in||0)}</span> <span style="color:var(--orange); font-weight:900;">Queima: ${Math.round((day.out||0) + bmr)}</span> </div> <div class="rep-pill-row"> <div class="rep-pill" style="color:var(--blue);">Prot: ${Math.round(day.prot||0)}g</div> <div class="rep-pill" style="color:var(--blue);">√Ågua: ${Math.round(day.water||0)}ml</div> <div class="rep-pill" style="color:var(--orange);">Sono: ${(day.sleep||0).toFixed(1)}h</div> <div class="rep-pill" style="color:#999;">Basal: ${Math.round(bmr)}kcal</div> </div> <div class="rep-insight">${insight}</div> </div> `; }); }
    function exportReport(){ let txt = "COACH REPORT REINAH FIT (PREMIUM)\n\n"; txt += `Saldo Total: ${document.getElementById('rep-net-total').innerText}\n`; txt += `M√©dia Prot: ${document.getElementById('rep-prot-avg').innerText}\n`; txt += `M√©dia √Ågua: ${document.getElementById('rep-water-avg').innerText}\n`; txt += `M√©dia Sono: ${document.getElementById('rep-sleep-avg').innerText}\n\n`; txt += document.getElementById('rep-list').innerText; navigator.clipboard.writeText(txt).then(()=>toast("Copiado!")); }
    function sysConfirm(msg, cb){ document.getElementById('cm-title').innerText = "Confirma√ß√£o"; document.getElementById('cm-msg').innerText = msg; const btn = document.getElementById('cm-btn-ok'); const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); newBtn.onclick = function(){ cb(); closeCustomModal(); }; openModal('custom-modal'); }
    function sysPrompt(title, cb){ document.getElementById('pm-title').innerText = title; document.getElementById('pm-input').value=''; promptCallback = cb; const btn = document.getElementById('pm-btn-ok'); const newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn); newBtn.onclick = function(){ const val = document.getElementById('pm-input').value; promptCallback(val); closePromptModal(); }; openModal('prompt-modal'); document.getElementById('pm-input').focus(); }
    function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
    function closeModal(id){ document.getElementById(id).classList.add('hidden'); }
    function closeCustomModal(){ document.getElementById('custom-modal').classList.add('hidden'); }
    function closePromptModal(){ document.getElementById('prompt-modal').classList.add('hidden'); }
    function exportDB(){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(db)],{type:'application/json'})); a.download=`backup_reinah_${getToday()}.json`; a.click(); }
    function importDB(e){ const r=new FileReader(); r.onload=function(evt){ try{ db=JSON.parse(evt.target.result); save(); location.reload(); } catch(err){ toast('Erro','err'); } }; r.readAsText(e.target.files[0]); }
    function openPhysicalModal(){ document.getElementById('bio-current-weight').value = db.user.weight; openModal('modal-physical'); }
    function openMedicalModal(){ openModal('modal-medical'); }
    function calculateBF(dc, age, sex){ const sum7 = dc.peitoral + dc.axilar + dc.triceps + dc.subescapular + dc.abdomen + dc.suprailiaca + dc.coxa; if(sum7 <= 0) return 0; let bd = sex === 'm' ? 1.112 - (0.00043499 * sum7) + (0.00000055 * sum7 * sum7) - (0.00028826 * age) : 1.097 - (0.00046971 * sum7) + (0.00000056 * sum7 * sum7) - (0.00012828 * age); return ((4.95 / bd) - 4.50) * 100; }
    function savePhysicalAssessment(){ const weight = parseFloat(document.getElementById('bio-current-weight').value) || db.user.weight; const dc = { peitoral: parseFloat(document.getElementById('bio-dc-peitoral').value)||0, axilar: parseFloat(document.getElementById('bio-dc-axilar').value)||0, triceps: parseFloat(document.getElementById('bio-dc-triceps').value)||0, subescapular: parseFloat(document.getElementById('bio-dc-subescapular').value)||0, abdomen: parseFloat(document.getElementById('bio-dc-abdomen').value)||0, suprailiaca: parseFloat(document.getElementById('bio-dc-suprailiaca').value)||0, coxa: parseFloat(document.getElementById('bio-dc-coxa').value)||0 }; const perim = { torax: parseFloat(document.getElementById('bio-p-torax').value)||0, cintura: parseFloat(document.getElementById('bio-p-cintura').value)||0, abdomen: parseFloat(document.getElementById('bio-p-abdomen').value)||0, quadril: parseFloat(document.getElementById('bio-p-quadril').value)||0, bracoD: parseFloat(document.getElementById('bio-p-braco-d').value)||0, bracoE: parseFloat(document.getElementById('bio-p-braco-e').value)||0, antebracoD: parseFloat(document.getElementById('bio-p-antebraco-d').value)||0, antebracoE: parseFloat(document.getElementById('bio-p-antebraco-e').value)||0, coxaD: parseFloat(document.getElementById('bio-p-coxa-d').value)||0, coxaE: parseFloat(document.getElementById('bio-p-coxa-e').value)||0, panturrilhaD: parseFloat(document.getElementById('bio-p-panturrilha-d').value)||0, panturrilhaE: parseFloat(document.getElementById('bio-p-panturrilha-e').value)||0 }; const bfPercent = calculateBF(dc, db.user.age, db.user.sex); const fatMass = weight * (bfPercent/100); const leanMass = weight - fatMass; db.assessments.push({ id: Date.now(), date: appDate, type:'physical', data:{ weight, dc, perim, bfPercent, leanMass } }); save(); closeModal('modal-physical'); toast("Salvo!"); loadProfileData(); }
    function saveMedicalAssessment(){ const data = { testoT: parseFloat(document.getElementById('med-testo-t').value) || 0, testoL: parseFloat(document.getElementById('med-testo-l').value) || 0, estradiol: parseFloat(document.getElementById('med-estradiol').value) || 0, glicose: parseFloat(document.getElementById('med-glicose').value) || 0, hba1c: parseFloat(document.getElementById('med-hba1c').value) || 0, ldl: parseFloat(document.getElementById('med-ldl').value) || 0, hdl: parseFloat(document.getElementById('med-hdl').value) || 0, trig: parseFloat(document.getElementById('med-trig').value) || 0, tgo: parseFloat(document.getElementById('med-tgo').value) || 0, tgp: parseFloat(document.getElementById('med-tgp').value) || 0, creatinina: parseFloat(document.getElementById('med-creatinina').value) || 0 }; db.assessments.push({ id: Date.now(), date: appDate, type:'medical', data }); save(); closeModal('modal-medical'); toast("Exames salvos!"); }
    
    // HIST√ìRICO: CORRIGIDO (Agora mostra exames e avalia√ß√µes)
    function openHistoryModal(){ 
        const list = document.getElementById('history-list'); 
        list.innerHTML=''; 
        // Filtra para mostrar TUDO (F√≠sico e M√©dico)
        const allItems = db.assessments.sort((a,b)=>b.date.localeCompare(a.date)); 
        if(allItems.length===0) list.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">Vazio</div>'; 
        else{ 
            allItems.forEach(a=>{ 
                let label = "Desconhecido";
                let valStr = "";
                // Identifica o tipo
                if(a.type === 'physical') {
                    label = "üìè F√≠sico";
                    valStr = `BF: ${(a.data.bfPercent||0).toFixed(1)}%`;
                } else if(a.type === 'medical') {
                    label = "ü©∏ M√©dico";
                    valStr = "Ver Exames";
                }

                list.innerHTML += ` 
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:#1a1a1a; border-bottom:1px solid #333; margin-bottom:8px; border-radius:14px;"> 
                    <div> 
                        <strong>${a.date.split('-').reverse().join('/')}</strong><br> 
                        <span style="font-size:0.8rem; color:var(--orange)">${label}</span> - <small style="color:#777">${valStr}</small> 
                    </div> 
                    <div style="display:flex; gap:15px;"> 
                        <i class="fas fa-eye" style="color:var(--blue); cursor:pointer;" onclick="openDashboard(${a.id})"></i> 
                        <i class="fas fa-trash" style="color:var(--red); cursor:pointer;" onclick="deleteAssessment(${a.id})"></i> 
                    </div> 
                </div>`; 
            }); 
        } 
        openModal('modal-history'); 
    }

    function deleteAssessment(id){ sysConfirm("Tem certeza que deseja excluir esta avalia√ß√£o?", ()=>{ db.assessments = db.assessments.filter(a=>a.id!==id); save(); openHistoryModal(); loadProfileData(); toast("Exclu√≠do."); }); }
    function openEvolutionModal(){ openModal('modal-evolution'); }
    function compareEvolution(){ /* TODO */ }

    // DASHBOARD DO LAUDO (BOT√ÉO AZUL CORRIGIDO)
    function openLatestReportModal(){
      const phys = db.assessments.filter(a=>a.type==='physical').sort((a,b)=>b.id-a.id);
      if(phys.length > 0) {
          openDashboard(phys[0].id); // Abre o mais recente
      } else {
          toast("Nenhuma avalia√ß√£o f√≠sica encontrada.", "err");
      }
    }

    // FUN√á√ÉO QUE PREENCHE O MODAL (DASHBOARD)
    function openDashboard(id) {
        const item = db.assessments.find(a => a.id === id);
        if(!item) return;

        let html = '';
        
        if(item.type === 'medical') {
            // Se for m√©dico, desenha lista de exames
            html += `<div class="modal-section-title">Resultados de Exames</div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">`;
            for(let key in item.data) {
                if(item.data[key] > 0) {
                    html += `<div class="d-card"><span class="d-val">${item.data[key]}</span><span class="d-lbl">${key.toUpperCase()}</span></div>`;
                }
            }
            html += `</div>`;
        } else {
            // Se for f√≠sico, desenha o Dashboard completo
            const d = item.data;
            const dc = d.dc || {};
            const p = d.perim || {};
            const sum7 = (dc.peitoral||0) + (dc.axilar||0) + (dc.triceps||0) + (dc.subescapular||0) + (dc.abdomen||0) + (dc.suprailiaca||0) + (dc.coxa||0);

            html += `
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
                <div class="d-card"><span class="d-val">${Number(d.weight).toFixed(1)}kg</span><span class="d-lbl">Peso</span></div>
                <div class="d-card"><span class="d-val" style="color:var(--red-pro);">${Number(d.bfPercent).toFixed(1)}%</span><span class="d-lbl">BF</span></div>
                <div class="d-card"><span class="d-val" style="color:var(--blue);">${Number(d.leanMass).toFixed(1)}kg</span><span class="d-lbl">Massa</span></div>
            </div>

            <div class="modal-section-title">Dobras Cut√¢neas (mm)</div>
            <div class="dash-grid-med" style="grid-template-columns: 1fr 1fr 1fr; gap:8px;">
                <div class="d-card"><span class="d-val">${dc.peitoral||0}</span><span class="d-lbl">Peitoral</span></div>
                <div class="d-card"><span class="d-val">${dc.axilar||0}</span><span class="d-lbl">Axilar</span></div>
                <div class="d-card"><span class="d-val">${dc.triceps||0}</span><span class="d-lbl">Tr√≠ceps</span></div>
                <div class="d-card"><span class="d-val">${dc.subescapular||0}</span><span class="d-lbl">Subescap.</span></div>
                <div class="d-card"><span class="d-val">${dc.abdomen||0}</span><span class="d-lbl">Abd√¥men</span></div>
                <div class="d-card"><span class="d-val">${dc.suprailiaca||0}</span><span class="d-lbl">Supra-Il.</span></div>
                <div class="d-card"><span class="d-val">${dc.coxa||0}</span><span class="d-lbl">Coxa</span></div>
                <div class="d-card" style="border-color:var(--orange);"><span class="d-val" style="color:var(--orange)">${sum7}</span><span class="d-lbl">Soma 7</span></div>
            </div>

            <div class="modal-section-title" style="margin-top:15px;">Perimetria (cm)</div>
            <div class="dash-grid-med" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap:8px;">
                <div class="d-card"><span class="d-val">${p.torax||0}</span><span class="d-lbl">T√≥rax</span></div>
                <div class="d-card"><span class="d-val">${p.cintura||0}</span><span class="d-lbl">Cintura</span></div>
                <div class="d-card"><span class="d-val">${p.abdomen||0}</span><span class="d-lbl">Abd√¥men</span></div>
                <div class="d-card"><span class="d-val">${p.quadril||0}</span><span class="d-lbl">Quadril</span></div>
                <div class="d-card"><span class="d-val">${p.bracoD||0}</span><span class="d-lbl">Bra√ßo D</span></div>
                <div class="d-card"><span class="d-val">${p.bracoE||0}</span><span class="d-lbl">Bra√ßo E</span></div>
                <div class="d-card"><span class="d-val">${p.coxaD||0}</span><span class="d-lbl">Coxa D</span></div>
                <div class="d-card"><span class="d-val">${p.coxaE||0}</span><span class="d-lbl">Coxa E</span></div>
            </div>
            <div style="text-align:center; margin-top:15px; font-size:0.7rem; color:#666;">Data: ${item.date.split('-').reverse().join('/')}</div>`;
        }

        document.getElementById('laudo-content').innerHTML = html; // Preenche o conte√∫do
        openModal("laudo-modal"); // Abre o modal
    }
  </script>
</body>
</html>